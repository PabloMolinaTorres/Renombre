<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Renombrador de Imágenes Falabella</title>
    <link rel="icon" href="https://raw.githubusercontent.com/PabloMolinaTorres/Visualiza2/main/falabella.png" type="image/png">
    <link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet">
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Last-Modified" content="0">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js?v=1.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.6.0/jszip.min.js?v=1.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip-utils/0.1.0/jszip-utils.min.js?v=1.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js?v=1.0"></script>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Lato', sans-serif;
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            color: #333;
            background-color: #fff;
        }
        .container {
            display: flex;
            height: 100%;
            width: 100%;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .form-container {
            width: 80%;
            max-width: 1000px;
            margin-bottom: 20px;
        }
        .form-group {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .form-group input {
            width: 48%;
            padding: 10px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .form-group input[type="text"] {
            flex-grow: 1;
        }
        .form-group button {
            padding: 10px 20px;
            background-color: #8fca00;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .form-group button:hover {
            background-color: #76a700;
        }
        .imgContainer {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        .imgWrapper {
            width: 200px;
            height: 200px;
            position: relative;
            display: block;
            overflow: hidden;
            border: 1px solid #eeeeee;
            text-align: center;
        }
        .imgWrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .download-icon {
            position: absolute;
            top: 0px;
            right: 0px;
            width: 24px;
            height: 24px;
            opacity: 0.8;
            cursor: pointer;
            background-image: url('https://raw.githubusercontent.com/PabloMolinaTorres/Visualiza2/main/descarga.png');
            background-size: cover;
        }
        .download-icon:hover {
            opacity: 1;
        }
        .button-group {
            margin-top: 20px;
            text-align: center;
        }
        .button-group button {
            padding: 10px 20px;
            background-color: #8fca00;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .button-group button:hover {
            background-color: #76a700;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="form-container">
            <div class="form-group">
                <input type="text" placeholder="Ingrese SKU" id="skuInput">
                <input type="text" placeholder="Nombre para renombrar la imagen" id="renameInput">
            </div>
            <div class="form-group">
                <button id="addSKU">Agregar SKU</button>
            </div>
        </div>
        <div class="imgContainer" id="imgContainer">
            <!-- Imágenes aparecerán aquí -->
        </div>
        <div class="button-group">
            <button id="downloadAll">Descargar Todo</button>
        </div>
    </div>

    <script>
        var skuList = [];

        function loadImage(sku, customName) {
            return new Promise(function(resolve, reject) {
                var baseUrl = 'https://imagedelivery.net/4fYuQyy-r8_rpBpcY7lH_A/falabellaCL/';
                var imgUrl = `${baseUrl}${sku}?w=1500,h=1500`;
                var img = new Image();
                img.src = imgUrl;
                img.alt = customName;

                img.onload = function() {
                    var wrapper = $('<div class="imgWrapper"><a href="' + imgUrl + '" target="_blank"></a></div>');
                    wrapper.find('a').append(img);

                    var downloadIcon = $('<div class="download-icon"></div>');
                    downloadIcon.click(function() {
                        downloadImage(imgUrl, customName);
                    });

                    wrapper.append(downloadIcon);
                    resolve(wrapper);
                };

                img.onerror = function() {
                    resolve(null); // Resolviendo la promesa sin añadir la miniatura "No disponible"
                };
            });
        }

        function downloadImage(url, customName) {
            JSZipUtils.getBinaryContent(url, function (err, data) {
                if (err) {
                    throw err;
                }
                saveAs(new Blob([data], { type: 'image/jpeg' }), customName + ".jpg");
            });
        }

        $('#addSKU').click(function() {
            var sku = $('#skuInput').val().trim();
            var customName = $('#renameInput').val().trim();

            if (sku && customName) {
                skuList.push({ sku: sku, customName: customName });
                loadImage(sku, customName).then(function(imageElement) {
                    if (imageElement) {
                        $('#imgContainer').append(imageElement);
                    } else {
                        alert('Imagen no disponible para SKU: ' + sku);
                    }
                });
                $('#skuInput').val('');
                $('#renameInput').val('');
            } else {
                alert('Por favor, complete ambos campos.');
            }
        });

        $('#downloadAll').click(function() {
            var zip = new JSZip();
            var count = 0;
            var zipFilename = getFormattedDate() + ".zip";
            var urls = [];
            var skuNames = [];

            skuList.forEach(function(item) {
                var baseUrl = 'https://imagedelivery.net/4fYuQyy-r8_rpBpcY7lH_A/falabellaCL/';
                var imgUrl = `${baseUrl}${item.sku}?w=1500,h=1500`;
                urls.push(imgUrl);
                skuNames.push(item.customName);
            });

            urls.forEach(function(url, index) {
                var filename = skuNames[index] + ".jpg";
                JSZipUtils.getBinaryContent(url, function (err, data) {
                    if (err) {
                        throw err;
                    }
                    zip.file(filename, data, { binary: true });
                    count++;
                    if (count === urls.length) {
                        zip.generateAsync({ type: 'blob' }).then(function (content) {
                            saveAs(content, zipFilename);
                        });
                    }
                });
            });
        });

        function getFormattedDate() {
            var date = new Date();
            var day = String(date.getDate()).padStart(2, '0');
            var month = String(date.getMonth() + 1).padStart(2, '0');
            var hours = String(date.getHours()).padStart(2, '0');
            var minutes = String(date.getMinutes()).padStart(2, '0');
            return day + '-' + month + '_' + hours + minutes;
        }
    </script>
</body>
</html>
